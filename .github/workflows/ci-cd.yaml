name: CI/CD for Papich

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**/api/**'
      - '**/README.md'
      - '**/.gitignore'
      - '**/.gitattributes'
      - '**/.github/workflows/ci-sonarcloud.yml'
      - '**/.github/workflows/update-api.yml'
      - '**/config/**'
      - '**/docker-compose-api.yml'

jobs:
  build:
    name: Build and Tests
    runs-on: ubuntu-latest
    outputs:
      jar-path: ${{ steps.upload.outputs.artifact-path || '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'
          cache: gradle

      - name: Build with Gradle
        env:
          INTERNAL_REPO_LOGIN: ${{ secrets.INTERNAL_REPO_LOGIN }}
          INTERNAL_REPO_PASSWORD: ${{ secrets.INTERNAL_REPO_PASSWORD }}
        run: |
          chmod +x gradlew
          ./gradlew clean build

      - name: Upload built jar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar
          retention-days: 1

  dockerized:
    name: Build and run in Docker
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4
      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./build/libs
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Run in Docker
        run: |
          docker compose -f docker-compose-test.yml pull --quiet
          docker compose -f docker-compose-test.yml up -d
          
          timeout 45s bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 3; done'
          
          if ! curl -f http://localhost:8080/actuator/health; then
            echo "Application failed to start within 45 seconds"
            exit 1
          fi
          
          docker compose -f docker-compose-test.yml down

  sonar_analysis:
    name: Sonar
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'
          cache: gradle
      - name: Sonar analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          INTERNAL_REPO_LOGIN: ${{ secrets.INTERNAL_REPO_LOGIN }}
          INTERNAL_REPO_PASSWORD: ${{ secrets.INTERNAL_REPO_PASSWORD }}
        run: ./gradlew sonar --info
    continue-on-error: true

  deploy:
    name: Deploy on Prod
    runs-on: ubuntu-latest
    needs: dockerized

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./build/libs

      - name: Build and Push Docker Image
        env:
          INTERNAL_REPO_LOGIN: ${{ secrets.INTERNAL_REPO_LOGIN }}
          INTERNAL_REPO_PASSWORD: ${{ secrets.INTERNAL_REPO_PASSWORD }}
        run: |
          IMAGE=ghcr.io/tpabka251/userservice
          docker buildx build \
            --build-arg INTERNAL_REPO_LOGIN=${INTERNAL_REPO_LOGIN} \
            --build-arg INTERNAL_REPO_PASSWORD=${INTERNAL_REPO_PASSWORD} \
            -t $IMAGE:latest \
            -t $IMAGE:${{ github.sha }} \
            --cache-from type=registry,ref=$IMAGE:latest \
            --push .
      - name: Deploy to k3s via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd User
            git pull origin master
            sudo kubectl apply -f k8s/deployment.yaml
            sudo kubectl apply -f k8s/service.yaml
            sudo kubectl rollout restart deployment/userservice
            sudo kubectl rollout status deployment/userservice -w